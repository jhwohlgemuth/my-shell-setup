#! /bin/bash
set -e

requires \
    git \
    install_extensions \
    java \
    jq \
    sponge
main() {
    #
    # Install Prusti crate
    #
    # shellcheck disable=SC2155
    local PWD="$(pwd)"
    git clone git@github.com:viperproject/prusti-dev.git /prusti
    cd /prusti || exit
    ./x.py setup && ./x.py build --release
    mv /prusti/target/release/prusti-rustc /usr/local/bin/
    chmod +x /usr/local/bin/prusti-rustc
    mv /prusti/target/release/cargo-prusti /usr/local/bin/
    chmod +x /usr/local/bin/cargo-prusti
    # shellcheck disable=SC2016
    echo 'export PATH="/prusti/bin:${PATH}"' >> "${HOME}/.zshrc"
    export PATH="/prusti/bin:${PATH}"
    rm -frd /prusti
    cd "${PWD}" || exit
    #
    # Install Prusti VSCode extension
    #
    install_extensions viper-admin.prusti-assistant
    #
    # Configure JAVA_HOME in Prusti extension settings
    #
    local SETTINGS="/app/code-server/config/data/User/settings.json"
    # shellcheck disable=SC2154
    jq ". += { \"prusti-assistant.javaHome\": \"${JAVA_HOME}\" }" "${SETTINGS}" | sponge "${SETTINGS}"
}
main "$@"
