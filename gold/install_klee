#! /bin/bash
set -e

requires \
    clang \
    git \
    cmake \
    make \
    z3
main() {
    # This is a hack to provide an old version of LLVM for Klee installation
    local PREFIX_PATH="${1:-/home/linuxbrew/.linuxbrew/opt/llvm@16}"
    #
    # Install KLEE
    #
    local SRC_DIRECTORY="${HOME}/klee"
    local BUILD_DIRECTORY="${SRC_DIRECTORY}/build"
    git clone https://github.com/klee/klee.git "${SRC_DIRECTORY}"
    mkdir -p "${BUILD_DIRECTORY}"
    pushd "${BUILD_DIRECTORY}" > /dev/null || exit
    export CMAKE_PREFIX_PATH="${PREFIX_PATH}"
    cmake -DENABLE_SOLVER_Z3=ON -DENABLE_POSIX_RUNTIME=ON -DENABLE_UNIT_TESTS=OFF -DENABLE_SYSTEM_TESTS=OFF "${SRC_DIRECTORY}"
    make
    mkdir -p "${HOME}/.local/bin"
    ln -s "${BUILD_DIRECTORY}/bin/klee" "${HOME}/.local/bin/klee"
    popd > /dev/null || exit
}
main "$@"
