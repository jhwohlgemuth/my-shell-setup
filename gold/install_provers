#! /bin/bash
set -e

requires \
    curl \
    git \
    is_command \
    make \
    opam \
    python \
    unzip
check_installed() {
    local MISSING=()
    local FOUND=()
    # Tools to check come from arguments; default to common set if none provided
    local tools=("$@")
    if [[ ${#tools[@]} -eq 0 ]]; then
        tools=(cvc5 vampire eprover z3 why3 alt-ergo)
    fi
    for tool in "${tools[@]}"; do
        if is_command "${tool}" > /dev/null 2>&1; then
            FOUND+=("${tool}")
        else
            MISSING+=("${tool}")
        fi
    done
    echo -e "\n=== Installation Verification ==="
    if [[ ${#FOUND[@]} -gt 0 ]]; then
        echo "=> [FOUND] ${FOUND[*]}"
    fi
    if [[ ${#MISSING[@]} -gt 0 ]]; then
        echo "=> [ERROR] Missing: ${MISSING[*]}"
    fi
    if [[ ${#MISSING[@]} -eq 0 ]]; then
        echo "=> [INFO] All tools installed successfully!"
        return 0
    else
        echo "=> [ERROR] Some tools are missing."
        return 1
    fi
}
install_alt_ergo() {
    local INSTALL_DIRECTORY="${1:-${HOME}/.local/bin}"
    export OPAMYES=1
    # Save the current opam switch to restore later
    local CURRENT_SWITCH
    CURRENT_SWITCH="$(opam switch show)"
    #
    # Create a compatible OCaml switch for Alt-Ergo (requires OCaml < 5)
    #
    if ! opam switch list --short | grep -q '^alt-ergo-4.14$'; then
        opam switch create alt-ergo-4.14 'ocaml-base-compiler.4.14'
    fi
    eval "$(opam env --switch=alt-ergo-4.14)"
    #
    # Install Alt-Ergo free
    #
    opam install alt-ergo-free
    # Symlink the installed binary into user bin
    mkdir -p "${INSTALL_DIRECTORY}"
    local ALT_BIN_DIR
    ALT_BIN_DIR="$(opam var bin)"
    if [[ -x "${ALT_BIN_DIR}/alt-ergo" ]]; then
        ln -sf "${ALT_BIN_DIR}/alt-ergo" "${INSTALL_DIRECTORY}/alt-ergo"
    elif [[ -x "${ALT_BIN_DIR}/alt-ergo-free" ]]; then
        ln -sf "${ALT_BIN_DIR}/alt-ergo-free" "${INSTALL_DIRECTORY}/alt-ergo"
    else
        echo "=> [WARNING] Alt-Ergo binary not found after install."
    fi
    # Restore the original opam switch
    eval "$(opam env --switch="${CURRENT_SWITCH}")"
}
install_why3() {
    export OPAMYES=1
    opam install why3
    eval "$(opam env)"
    why3 config detect
}
install_cvc5() {
    local INSTALL_DIRECTORY="${1:-${HOME}/.local/bin}"
    mkdir -p "${INSTALL_DIRECTORY}"
    pushd "${INSTALL_DIRECTORY}" > /dev/null || exit
    curl -o cvc5 -LJ https://github.com/cvc5/cvc5/releases/download/cvc5-1.0.8/cvc5-Linux
    chmod +x cvc5
    popd > /dev/null || exit
}
install_vampire() {
    local INSTALL_DIRECTORY="${1:-${HOME}/.local/bin}"
    mkdir -p "${INSTALL_DIRECTORY}"
    mkdir -p "${HOME}/vampire"
    pushd "${HOME}/vampire" > /dev/null || exit
    curl -o source.zip -LJ https://github.com/vprover/vampire/releases/download/snakeForV4.7%2B/vampire-snake-static4starexec.zip
    unzip source.zip
    mv bin/* "${INSTALL_DIRECTORY}"
    popd > /dev/null || exit
    rm -frd "${HOME}/vampire"
}
install_eprover() {
    local INSTALL_DIRECTORY="${1:-${HOME}/.local/bin}"
    mkdir -p "${INSTALL_DIRECTORY}"
    git clone https://github.com/eprover/eprover.git "${HOME}/eprover"
    pushd "${HOME}/eprover" > /dev/null || exit
    ./configure && make -j8 && make install
    mv PROVER/eprover "${INSTALL_DIRECTORY}"
    popd > /dev/null || exit
    rm -frd "${HOME}/eprover"
}
install_z3() {
    local INSTALL_DIRECTORY="${1:-${HOME}/.local/bin}"
    # Derive install prefix (strip trailing /bin if provided)
    local PREFIX_DIR="${INSTALL_DIRECTORY}"
    case "${INSTALL_DIRECTORY}" in
        */bin) PREFIX_DIR="${INSTALL_DIRECTORY%/bin}" ;;
        *) PREFIX_DIR="${INSTALL_DIRECTORY}" ;;
    esac
    mkdir -p "${INSTALL_DIRECTORY}"
    git clone https://github.com/Z3Prover/z3.git "${HOME}/z3"
    pushd "${HOME}/z3" > /dev/null || exit
    python scripts/mk_make.py --prefix="${PREFIX_DIR}"
    pushd build > /dev/null || exit
    make -j8 && make install
    popd > /dev/null || exit
    popd > /dev/null || exit
    rm -frd "${HOME}/z3"
}
main() {
    local INSTALL_DIRECTORY="${1:-${HOME}/.local/bin}"
    install_cvc5 "${INSTALL_DIRECTORY}"
    install_eprover "${INSTALL_DIRECTORY}"
    install_vampire "${INSTALL_DIRECTORY}"
    install_z3 "${INSTALL_DIRECTORY}"
    install_why3
    check_installed cvc5 eprover vampire z3 why3
}
main "$@"
