#! /bin/bash
set -e

requires \
    binfmt-support \
    curl \
    sudo \
    unzip
main() {
    local APE_BIN_PATH="/usr/bin/ape"
    local APE_TEMP="/tmp/ape-$(uname -m).elf"
    #
    # Install APE loader
    #
    curl -o "${APE_TEMP}" "https://cosmo.zip/pub/cosmos/bin/ape-$(uname -m).elf"
    sudo mv "${APE_TEMP}" "${APE_BIN_PATH}"
    sudo chmod +x "${APE_BIN_PATH}"
    # Mount binfmt_misc if not already mounted
    if ! mountpoint -q /proc/sys/fs/binfmt_misc; then
        sudo mount -t binfmt_misc none /proc/sys/fs/binfmt_misc || {
            printf "==> [WARNING] Could not mount binfmt_misc\\n"
            return 1
        }
    fi
    # Register APE handlers
    if [[ -w /proc/sys/fs/binfmt_misc/register ]]; then
        echo ':APE:M::MZqFpD::'"${APE_BIN_PATH}"':' | sudo tee /proc/sys/fs/binfmt_misc/register > /dev/null 2>&1 || {
            printf "==> [WARNING] Failed to register APE handler\\n"
        }
        echo ':APE-jart:M::jartsr::'"${APE_BIN_PATH}"':' | sudo tee /proc/sys/fs/binfmt_misc/register > /dev/null 2>&1 || {
            printf "==> [WARNING] Failed to register APE-jart handler\\n"
        }
        # Verify registration
        if [[ -f /proc/sys/fs/binfmt_misc/APE ]]; then
            printf "==> [SUCCESS] APE handler registered\\n"
        fi
    fi
    sudo update-binfmts --enable
}
main "$@"
